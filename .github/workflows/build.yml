name: Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Qt (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y qt6-base-dev qt6-base-dev-tools cmake build-essential
    
    - name: Install Qt (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        python -m pip install aqtinstall
        # Устанавливаем Qt - qtbase уже включен в базовую установку
        aqt install-qt windows desktop 6.5.3 win64_msvc2019_64 --outputdir C:\Qt
        $env:CMAKE_PREFIX_PATH = "C:\Qt\6.5.3\msvc2019_64"
        echo "CMAKE_PREFIX_PATH=$env:CMAKE_PREFIX_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    
    - name: Configure CMake (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $qtPath = "C:\Qt\6.5.3\msvc2019_64"
        Write-Host "Using Qt path: $qtPath"
        
        if (Test-Path "$qtPath\lib\cmake\Qt6") {
          Write-Host "✅ Found Qt at: $qtPath"
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$qtPath"
        } else {
          Write-Host "⚠️  Qt path not found, trying without CMAKE_PREFIX_PATH"
          Write-Host "CMake will try to find Qt automatically"
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
        }
    
    - name: Configure CMake (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: |
        cmake --build build --config Release
    
    - name: Check build artifacts (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $exeFound = $false
        if (Test-Path "build/bin/Release/LibrarySystem.exe") {
          Write-Host "✅ Build successful: found build/bin/Release/LibrarySystem.exe"
          $exeFound = $true
        }
        if (Test-Path "build/bin/LibrarySystem.exe") {
          Write-Host "✅ Build successful: found build/bin/LibrarySystem.exe"
          $exeFound = $true
        }
        if (Test-Path "build/Release/bin/LibrarySystem.exe") {
          Write-Host "✅ Build successful: found build/Release/bin/LibrarySystem.exe"
          $exeFound = $true
        }
        if (-not $exeFound) {
          Write-Host "❌ Build failed - executable not found"
          Write-Host "Searching for executable..."
          Get-ChildItem -Path build -Recurse -Filter "LibrarySystem.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          exit 1
        }
    
    - name: Check build artifacts (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        if [ -f "build/bin/LibrarySystem" ]; then
          echo "✅ Build successful: found build/bin/LibrarySystem"
        else
          echo "❌ Build failed - executable not found"
          echo "Searching for executable..."
          find build -name "LibrarySystem" -type f 2>/dev/null || echo "No executable found"
          exit 1
        fi
